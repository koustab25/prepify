<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prepify - Your Questions</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --primary-dark: #3a0ca3;
      --secondary: #f72585;
      --accent: #4cc9f0;
      --bg: #f8f9fa;
      --text: #2b2d42;
      --text-light: #6c757d;
      --white: #ffffff;
      --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      --success: #4ade80;
    }
    
    .essay-controls {
      margin: 1rem 0;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .essay-controls label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .marks-selector {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-right: 10px;
    }

    .generate-answer-btn {
      padding: 8px 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }

    .generate-answer-btn:disabled {
      background: var(--text-light);
      cursor: not-allowed;
    }

    .model-answer {
      margin-top: 1rem;
      padding: 1rem;
      background: #f0f9ff;
      border-left: 4px solid var(--primary);
      border-radius: 4px;
    }

    .loading {
      padding: 1rem;
      text-align: center;
      color: var(--text-light);
    }

    .error {
      padding: 1rem;
      color: var(--secondary);
      background: #ffe6e6;
      border-radius: 4px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      font-size: 2rem;
      color: var(--primary);
    }

    .logo-text {
      font-size: 1.8rem;
      font-weight: 700;
      background: linear-gradient(to right, var(--primary), var(--primary-dark));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .back-btn {
      background: var(--white);
      color: var(--primary);
      border: 1px solid var(--primary);
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin: 10px;
      
    }

    .back-btn:hover {
      background: var(--primary);
      color: var(--white);
    }

    .questions-container {
      background: var(--white);
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .page-title {
      font-size: 1.8rem;
      margin-bottom: 1.5rem;
      color: var(--text);
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .filter-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 8px 16px;
      background: var(--white);
      border: 1px solid #ddd;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.9rem;
    }

    .filter-btn.active {
      background: var(--primary);
      color: var(--white);
      border-color: var(--primary);
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
    }

    .action-btn {
      padding: 8px 16px;
      background: var(--primary);
      color: var(--white);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .action-btn:hover {
      background: var(--primary-dark);
    }

    .question-card {
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      background: white;
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
      align-items: center;
      cursor: pointer;
    }

    .question-type {
      background: var(--primary);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .question-number {
      color: var(--text-light);
      font-size: 0.9rem;
    }

    .question-content {
      margin-bottom: 1rem;
    }

    .question-text {
      font-size: 1.1rem;
      margin-bottom: 1rem;
      line-height: 1.5;
    }

    .options {
      margin: 1rem 0;
    }

    .option {
      padding: 0.75rem;
      margin: 0.5rem 0;
      border: 1px solid #e1e5e9;
      border-radius: 6px;
      transition: all 0.3s;
    }

    .option.correct {
      background: #f0f9ff;
      border-color: var(--primary);
      color: var(--primary);
      font-weight: 500;
    }

    .solution {
      margin-top: 1rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 6px;
      display: none;
    }

    .solution.show {
      display: block;
    }

    .solution-answer {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--primary-dark);
    }

    .solution-explanation {
      color: var(--text);
      line-height: 1.5;
    }

    .loading-container {
      text-align: center;
      padding: 3rem;
      display: none;
    }

    .loading-spinner {
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 1rem;
    }

    .loading-text {
      color: var(--text-light);
    }

    .error-container {
      text-align: center;
      padding: 2rem;
      color: var(--secondary);
    }

    .retry-btn {
      margin-top: 1rem;
      padding: 8px 16px;
      background: var(--secondary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .quiz-section {
      margin-top: 3rem;
      padding-top: 2rem;
      border-top: 1px solid #e1e5e9;
      text-align: center;
    }

    .quiz-title {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      color: var(--text);
    }

    .quiz-buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .quiz-btn {
      padding: 12px 24px;
      background: var(--primary);
      color: var(--white);
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .quiz-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .quiz-btn.disabled {
      background: var(--text-light);
      cursor: not-allowed;
      transform: none;
    }

    @media (max-width: 768px) {
      .controls {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .action-buttons {
        width: 100%;
        justify-content: space-between;
      }
      
      .quiz-buttons {
        flex-direction: column;
      }
      
      .quiz-btn {
        width: 100%;
      }
    
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <i class="fa-solid fa-atom logo-icon"></i>
        <div class="logo-text">Prepify</div>
      </div>
      <a href="upload.html" class="back-btn">
        <i class="fas fa-arrow-left"></i> Upload New File
      </a>
    </header>

    <div class="questions-container">
      <h1 class="page-title">Your Generated Questions</h1>
      
      <div class="controls">
        <div class="filter-buttons">
          <button class="filter-btn active" data-filter="all">All Questions</button>
          <button class="filter-btn" data-filter="mcq">Multiple Choice</button>
          <button class="filter-btn" data-filter="short_answer">Short Answer</button>
          <button class="filter-btn" data-filter="true_false">True/False</button>
          <button class="filter-btn" data-filter="essay">Essay Questions</button>
        </div>
        
        <div class="action-buttons">
          <button class="action-btn" id="exportBtn">
            <i class="fas fa-download"></i> Export
          </button>
          <button class="action-btn" id="newQuizBtn">
            <i class="fas fa-plus"></i> New Quiz
          </button>
        </div>
      </div>
      
      <div id="questionsList">
        <div class="loading-container" id="mainLoading">
          <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
          </div>
          <p class="loading-text">Generating your questions...</p>
        </div>
      </div>
      
      <div class="quiz-section">
        <h2 class="quiz-title">Ready to test your knowledge?</h2>
        <div class="quiz-buttons">
          <button class="quiz-btn disabled" id="startQuizBtn">
            <i class="fas fa-play-circle"></i> Start Quiz
          </button>
          <button class="quiz-btn disabled" id="takeTestBtn">
            <i class="fas fa-file-alt"></i> Take Test
          </button>
        </div>
        <p class="quiz-note">Quiz and test features will be available soon</p>
      </div>
    </div>
  </div>

  <script>
    // Groq API configuration
    const GROQ_API_KEY = "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";
    const GROQ_API_URL = "https://api.groq.com/openai/v1/chat/completions";
    
    // DOM elements
    const questionsList = document.getElementById('questionsList');
    const filterButtons = document.querySelectorAll('.filter-btn');
    const startQuizBtn = document.getElementById('startQuizBtn');
    const takeTestBtn = document.getElementById('takeTestBtn');
    const mainLoading = document.getElementById('mainLoading');
    
    // Store questions and current filter
    let allQuestions = [];
    let currentFilter = 'all';
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', async function() {
      // Show loading state
      mainLoading.style.display = 'block';
      
      // Get the extracted text from localStorage
      const extractedText = localStorage.getItem('extractedText');
      const preferences = JSON.parse(localStorage.getItem('questionSettings') || '{}');
      
      // Log the retrieved settings to debug
      console.log("Retrieved settings:", preferences);
      
      if (!extractedText) {
        showError('No document text found. Please upload a file first.');
        return;
      }
      
      try {
        // Generate questions using Groq API with the user's preferences
        const questions = await generateQuestionsWithGroq(extractedText, preferences);
        allQuestions = questions;
        
        // Render questions
        renderQuestions(allQuestions);
        
        // Hide loading state
        mainLoading.style.display = 'none';
        
      } catch (error) {
        console.error('Error:', error);
        showError('Failed to generate questions: ' + error.message);
        mainLoading.style.display = 'none';
      }
    });

    // Improved JSON extraction function
   function extractJSONFromText(text) {
  console.log("Raw text for JSON extraction:", text);
  
  // First, try to find JSON object pattern
  const jsonMatch = text.match(/\{[\s\S]*\}/);
  if (!jsonMatch) {
    console.error("No JSON object found in response");
    throw new Error('No JSON object found in response');
  }
  
  let jsonString = jsonMatch[0];
  console.log("Extracted JSON string:", jsonString);
  
  try {
    return JSON.parse(jsonString);
  } catch (parseError) {
    console.error('JSON parsing failed:', parseError);
    console.error('Problematic JSON string:', jsonString);
    
    // Try to fix common JSON issues
    try {
      // Remove any text before the first { and after the last }
      jsonString = jsonString.replace(/^[^{]*/, '').replace(/[^}]*$/, '');
      
      // Fix unquoted property names
      jsonString = jsonString.replace(/([{,]\s*)([a-zA-Z_$][a-zA-Z0-9_$]*)(\s*:)/g, '$1"$2"$3');
      
      // Fix single quotes to double quotes
      jsonString = jsonString.replace(/'/g, '"');
      
      console.log("Attempting to parse fixed JSON:", jsonString);
      return JSON.parse(jsonString);
    } catch (secondError) {
      console.error('Second parsing attempt also failed:', secondError);
      throw new Error('Invalid JSON format in AI response');
    }
  }
}
    // Generate questions using Groq API
    async function generateQuestionsWithGroq(text, preferences) {
      // Use the preferences from localStorage
      const { count = 10, difficulty = 'medium', types = ['mcq', 'shortAnswer'] } = preferences;
      
      console.log("Using settings:", { count, difficulty, types });
      
      // Convert question type IDs to API format
      const typeMapping = {
        'mcq': 'mcq',
        'shortAnswer': 'short_answer',
        'trueFalse': 'true_false',
        'essay': 'essay'
      };
      
      const apiQuestionTypes = types.map(type => typeMapping[type] || type);
      
      const prompt = `
        Create  ${count}(not one less, not one more) ${difficulty}-difficulty questions based on the following text.
        Include only these question types: ${apiQuestionTypes.join(', ')}.
        
        TEXT:
        ${text.substring(0, 3000)}
        
        Return ONLY valid JSON with this exact structure Do not include any other text:
        {
          "questions": [
            {
              "type": "mcq",
              "question": "What is the capital of France?",
              "options": ["London", "Berlin", "Paris", "Madrid"],
              "correctAnswer": 2,
              "explanation": "Paris has been the capital of France since 987."
            },
            {
              "type": "short_answer",
              "question": "Name the longest river in France.",
              "correctAnswer": "Loire River",
              "explanation": "The Loire River is the longest river in France at 1,006 km."
            },
            {
              "type": "true_false",
              "question": "France is located in South America.",
              "correctAnswer": false,
              "explanation": "France is located in Western Europe."
            },
            {
              "type": "essay",
              "question": "Discuss the impact of the French Revolution on European politics.",
              "explanation": "This essay question requires a detailed analysis of the French Revolution's effects."
            }
          ]
        }
           Important: Your response must contain ONLY the JSON object, without any additional text, explanations, or prefixes.
      `;
      
      try {
        const response = await fetch(GROQ_API_URL, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${GROQ_API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: "llama3-8b-8192",
            messages: [
              {
                role: "user",
                content: prompt
              }
            ],
            temperature: 0.7,
            max_tokens: 2000
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          console.error('API Error Details:', errorData);
          throw new Error(`API error: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        const content = data.choices[0].message.content;
        
        // Log the raw response for debugging
        console.log("Raw API response:", content);
        
        // Extract and parse JSON from the response
        try {
          const result = extractJSONFromText(content);
          return result.questions || [];
        } catch (parseError) {
          console.error("Failed to parse JSON:", parseError);
          console.error("Problematic content:", content);
          throw new Error('Invalid JSON format in AI response');
        }
        
      } catch (error) {
        console.error('Groq API error:', error);
        
        // Fallback to sample questions if API fails
        if (error.message.includes('404') || error.message.includes('Failed to fetch')) {
          console.warn('API returned error, using sample questions');
          return generateSampleQuestions();
        }
        
        throw new Error('Failed to generate questions: ' + error.message);
      }
    }
    
    // Generate sample questions as fallback
    function generateSampleQuestions() {
      return [
        {
          type: "mcq",
          question: "What is the main purpose of studying?",
          options: ["To pass exams", "To gain knowledge", "To please parents", "To get a job"],
          correctAnswer: 1,
          explanation: "The primary purpose of studying is to gain knowledge and understanding of subjects."
        },
        {
          type: "short_answer",
          question: "Name one effective study technique.",
          correctAnswer: "Spaced repetition",
          explanation: "Spaced repetition is a learning technique that involves increasing intervals of time between subsequent reviews of previously learned material."
        },
        {
          type: "true_false",
          question: "Cramming the night before an exam is an effective study strategy.",
          correctAnswer: false,
          explanation: "Cramming is not effective for long-term retention and understanding of material."
        },
        {
          type: "essay",
          question: "Discuss the importance of time management in academic success.",
          explanation: "This essay should explore how effective time management contributes to better learning outcomes."
        }
      ];
    }
    
    // Render questions based on current filter
    function renderQuestions(questions) {
      if (questions.length === 0) {
        questionsList.innerHTML = `
          <div class="error-container">
            <p>No questions available for the selected filter.</p>
          </div>
        `;
        return;
      }
      
      questionsList.innerHTML = '';
      
      questions.forEach((question, index) => {
        if (currentFilter !== 'all' && question.type !== currentFilter) {
          return;
        }
        
        const questionEl = createQuestionElement(question, index);
        questionsList.appendChild(questionEl);
      });
      
      // Setup essay answer buttons after rendering
      setupEssayAnswerButtons();
    }
    
    // Create HTML for a question
    function createQuestionElement(question, index) {
      const div = document.createElement('div');
      div.className = 'question-card';
      
      let optionsHTML = '';
      let solutionHTML = '';
      
      if (question.type === 'mcq' && question.options) {
        optionsHTML = `
          <div class="options">
            ${question.options.map((option, i) => `
              <div class="option ${i === question.correctAnswer ? 'correct' : ''}">
                ${String.fromCharCode(65 + i)}. ${option}
              </div>
            `).join('')}
          </div>
        `;
        
        solutionHTML = `
          <p class="solution-answer">Answer: ${String.fromCharCode(65 + question.correctAnswer)}</p>
          <p class="solution-explanation">${question.explanation || 'No explanation provided.'}</p>
        `;
      } else if (question.type === 'true_false') {
        optionsHTML = `
          <div class="options">
            <div class="option ${question.correctAnswer === true ? 'correct' : ''}">True</div>
            <div class="option ${question.correctAnswer === false ? 'correct' : ''}">False</div>
          </div>
        `;
        
        solutionHTML = `
          <p class="solution-answer">Answer: ${question.correctAnswer ? 'True' : 'False'}</p>
          <p class="solution-explanation">${question.explanation || 'No explanation provided.'}</p>
        `;
      } else if (question.type === 'short_answer') {
        solutionHTML = `
          <p class="solution-answer">Answer: ${question.correctAnswer || 'No answer provided'}</p>
          <p class="solution-explanation">${question.explanation || 'No explanation provided.'}</p>
        `;
      } else if (question.type === 'essay') {
        // Special handling for essay questions
        solutionHTML = `
          <div class="essay-controls">
            <label>Select marks for this essay:</label>
            <select class="marks-selector">
              <option value="5">5 marks</option>
              <option value="10">10 marks</option>
              <option value="15">15 marks</option>
              <option value="20">20 marks</option>
            </select>
            <button class="generate-answer-btn" data-question="${index}">
             Generate with AI
            </button>
          </div>
          <div class="essay-answer" id="essay-answer-${index}"></div>
          ${question.explanation ? `<p class="solution-explanation">${question.explanation}</p>` : ''}
        `;
      }
      
      div.innerHTML = `
        <div class="question-header" onclick="toggleSolution(this)">
          <span class="question-type">${formatQuestionType(question.type)}</span>
          <span class="question-number">Question ${index + 1}</span>
          <i class="fas fa-chevron-down"></i>
        </div>
        <div class="question-content">
          <p class="question-text">${question.question}</p>
          ${optionsHTML}
        </div>
        <div class="solution">
          ${solutionHTML}
        </div>
      `;
      
      return div;
    }
    
    // Add this function to handle essay answer generation
    function setupEssayAnswerButtons() {
      document.querySelectorAll('.generate-answer-btn').forEach(button => {
        button.addEventListener('click', async function() {
          const questionIndex = parseInt(this.dataset.question);
          const marks = this.parentElement.querySelector('.marks-selector').value;
          const answerContainer = document.getElementById(`essay-answer-${questionIndex}`);
          const questionText = allQuestions[questionIndex].question;
          
          // Show loading state
          answerContainer.innerHTML = '<div class="loading">Generating answer...</div>';
          this.disabled = true;
          
          try {
            const answer = await generateEssayAnswer(questionText, marks);
            answerContainer.innerHTML = `<div class="model-answer"><h4>Model Answer (${marks} marks):</h4><p>${answer}</p></div>`;
          } catch (error) {
            answerContainer.innerHTML = `<div class="error">Failed to generate answer: ${error.message}</div>`;
            this.disabled = false;
          }
        });
      });
    }
    
    async function generateEssayAnswer(question, marks) {
      const prompt = `
        Create a model answer for this essay question worth ${marks} marks.
        The answer should be comprehensive,with points and spacing, well-structured, and appropriate for the mark allocation.
        
        QUESTION: ${question}
        
        Provide only the answer content without any additional commentary.
      `;
      
      try {
        const response = await fetch(GROQ_API_URL, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${GROQ_API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: "llama3-8b-8192",
            messages: [
              {
                role: "user",
                content: prompt
              }
            ],
            temperature: 0.7,
            max_tokens: 1024
          })
        });
        
        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }
        
        const data = await response.json();
        return data.choices[0].message.content;
      } catch (error) {
        console.error('Error generating essay answer:', error);
        throw error;
      }
    }
    
    // Toggle solution visibility
    function toggleSolution(header) {
      const solution = header.parentElement.querySelector('.solution');
      const icon = header.querySelector('i');
      
      if (solution.style.display === 'block') {
        solution.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
      } else {
        solution.style.display = 'block';
        icon.className = 'fas fa-chevron-up';
      }
    }
    
    // Format question type for display
    function formatQuestionType(type) {
      const typeMap = {
        'mcq': 'Multiple Choice',
        'short_answer': 'Short Answer',
        'true_false': 'True/False',
        'essay': 'Essay'
      };
      
      return typeMap[type] || type;
    }
    
    // Show error message
    function showError(message) {
      questionsList.innerHTML = `
        <div class="error-container">
          <p><i class="fas fa-exclamation-circle"></i> ${message}</p>
          <button class="retry-btn" onclick="window.location.href='upload.html'">
            Go Back to Upload
          </button>
        </div>
      `;
    }
    

    // Set up filter buttons
    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        filterButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        currentFilter = button.dataset.filter;
        renderQuestions(allQuestions);
      });
    });
    
    // Set up action buttons
     // Set up export button
document.getElementById('exportBtn').addEventListener('click', () => {
  // Prepare data for export
  const exportData = {
    questions: allQuestions,
    exportDate: new Date().toISOString(),
    documentTitle: localStorage.getItem('documentTitle') || 'Prepify Questions'
  };
  
  // Save to localStorage
  localStorage.setItem('exportData', JSON.stringify(exportData));
  
  // Redirect to export page
  window.location.href = 'export.html';
});
    
    document.getElementById('newQuizBtn').addEventListener('click', () => {
      window.location.href = 'upload.html';
    });
  </script>
</body>
</html>
